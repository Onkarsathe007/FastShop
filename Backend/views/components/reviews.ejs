<!-- Customer Reviews -->
<div class="mt-8 bg-white rounded-lg shadow-sm border">
    <div class="p-6">
        <h2 class="text-xl font-bold mb-4">Customer Reviews</h2>
        <!-- Review Summary -->
        <div class="flex items-center mb-6 pb-6 border-b">
            <div class="flex items-center mr-8">
                <span class="text-4xl font-bold mr-2">
                    <%=product.rating%>
                </span>
                    <div>
                        <div class="flex text-yellow-400 text-lg">
                            <% for(let star=1; star<=5; star++) { %>
                                <% if(star <= Math.floor(product.rating)) { %>
                                    ★
                                <% } else { %>
                                    ☆
                                <% } %>
                            <% } %>
                        </div>
                        <p class="text-sm text-gray-600">out of 5</p>
                    </div>            </div>
            <div class="text-sm text-gray-600">
                <p>
                    <%=product.reviews.length%> customer reviews
                </p>
            </div>
        </div>

        <!-- Individual Reviews -->
        <div class="space-y-6">
            <%for(var i=0; i <product.reviews.length; i++){%>
                <div class="border-b pb-6" id="review-<%=i%>">
                    <!-- Review Display -->
                    <div id="reviewDisplay-<%=i%>">
                        <div class="flex items-start justify-between mb-2">
                            <div>
                                <div class="flex items-center mb-1">
                                    <div class="flex text-yellow-400 mr-2">
                                        <% for(let star=1; star<=5; star++) { %>
                                            <% if(star <= Math.floor(product.reviews[i].rating)) { %>
                                                ★
                                            <% } else { %>
                                                ☆
                                            <% } %>
                                        <% } %>
                                    </div>
                                    <span class="font-medium">
                                        <%= product.reviews[i].reviewerName%>
                                    </span>
                                </div>
                                <p class="text-sm text-gray-600">
                                    <% const rawDate=product.reviews[i].date; const dateObj=new Date(rawDate); const
                                        formattedDate=dateObj.toLocaleDateString("en-US", { day: "2-digit" , month: "long" ,
                                        year: "numeric" }); %>
                                        Reviewed on: <%= formattedDate %>
                                </p>
                            </div>
                            <% if (currentUser && String(currentUser._id) === String(product.reviews[i].reviewer)) { %>
                                <button
                                    class="bg-blue-500 text-white px-4 py-1 rounded text-sm hover:bg-blue-600 transition-colors"
                                    onclick="toggleEditForm(<%=i%>)">
                                    Edit
                                </button>
                            <% } %>
                        </div>
                        <p class="text-gray-700">
                            <%=product.reviews[i].comment%>
                        </p>
                    </div>

                    <!-- Edit Form (Initially Hidden) -->
                    <% if (currentUser && String(currentUser._id) === String(product.reviews[i].reviewer)) { %>
                        <div id="editForm-<%=i%>" class="mt-4 p-4 bg-gray-50 rounded-lg hidden">
                            <h3 class="text-lg font-medium mb-4">Edit Your Review</h3>
                            <form method="post" action="/products/<%=product._id%>/reviews/<%=product.reviews[i]._id%>?_method=PUT">
   
                            <fieldset class="starability-basic">
                              <legend>First rating:</legend>
                              <input type="radio" id="no-rate-edit-<%=i%>" class="input-no-rate" name="reviewCount" value="0" checked aria-label="No rating." />
                              <input type="radio" id="edit-rate1-<%=i%>" name="reviewCount" value="1" />
                              <label for="edit-rate1-<%=i%>" title="Terrible">1 star</label>
                              <input type="radio" id="edit-rate2-<%=i%>" name="reviewCount" value="2" />
                              <label for="edit-rate2-<%=i%>" title="Not good">2 stars</label>
                              <input type="radio" id="edit-rate3-<%=i%>" name="reviewCount" value="3" />
                              <label for="edit-rate3-<%=i%>" title="Average">3 stars</label>
                              <input type="radio" id="edit-rate4-<%=i%>" name="reviewCount" value="4" />
                              <label for="edit-rate4-<%=i%>" title="Very good">4 stars</label>
                              <input type="radio" id="edit-rate5-<%=i%>" name="reviewCount" value="5" />
                              <label for="edit-rate5-<%=i%>" title="Amazing">5 stars</label>
                            </fieldset>
                                <!-- <div class="mb-4"> -->
                                <!--     <label class="block text-sm font-medium text-gray-700 mb-2">Rating</label> -->
                                <!--     <input type="number"  -->
                                <!--         class="w-half px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" -->
                                <!--         name="reviewCount" min="1" max="5" value="<%=product.reviews[i].rating%>" required> -->
                                <!-- </div> -->
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Your Name</label>
                                    <input type="text" 
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        name="reviewerName" value="<%=product.reviews[i].reviewerName%>" required>
                                </div>
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Your Review</label>
                                    <textarea rows="4"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        name="review" required><%=product.reviews[i].comment%></textarea>
                                </div>
                                <div class="flex space-x-3">
                                    <button type="submit"
                                        class="bg-green-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-green-500 transition-colors">
                                        Update Review
                                    </button>
                                    <button type="button" onclick="toggleEditForm(<%=i%>)"
                                        class="bg-gray-300 text-gray-700 px-6 py-2 rounded-lg font-medium hover:bg-gray-400 transition-colors">
                                        Cancel
                                    </button>
                                </div>
                            </form>
                        </div>
                    <% } %>
                </div>
            <%}%>
        </div>
        
        <!-- Write Review Button -->
        <div class="mt-6 pt-6 border-t">
      <% if (currentUser && product && product.owner && currentUser._id.toString() !== product.owner._id.toString()) { %> 
            <button
                class="bg-gray-100 text-gray-800 px-6 py-2 rounded-lg font-medium hover:bg-gray-200 transition-colors"
                onclick="toggleReviewForm()" id="addReview">
                Write a Review
            </button>
      <%}%>
            <!-- Review Form (Initially Hidden) -->
            <div id="reviewForm" class="mt-6 p-4 bg-gray-50 rounded-lg hidden">
                <h3 class="text-lg font-medium mb-4">Write Your Review</h3>
                <form method="post" name="reviewForm" action="/products/<%=product._id%>/reviews">

                    <!-- <div class="mb-4"> -->
                    <!--     <label class="block text-sm font-medium text-gray-700 mb-2">Rating</label> -->
                    <!--     <input type="number" id="reviewCount" -->
                    <!--         class="w-half px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" -->
                    <!--         placeholder="e.g: 4" name="reviewCount" min="1" max="5" required> -->
                    <!-- </div> -->
                    <fieldset class="starability-basic">
                              <legend>First rating:</legend>
                              <input type="radio" id="no-rate-add" class="input-no-rate" name="reviewCount" value="0" checked aria-label="No rating." />
                              <input type="radio" id="add-rate1" name="reviewCount" value="1" />
                              <label for="add-rate1" title="Terrible">1 star</label>
                              <input type="radio" id="add-rate2" name="reviewCount" value="2" />
                              <label for="add-rate2" title="Not good">2 stars</label>
                              <input type="radio" id="add-rate3" name="reviewCount" value="3" />
                              <label for="add-rate3" title="Average">3 stars</label>
                              <input type="radio" id="add-rate4" name="reviewCount" value="4" />
                              <label for="add-rate4" title="Very good">4 stars</label>
                              <input type="radio" id="add-rate5" name="reviewCount" value="5" />
                              <label for="add-rate5" title="Amazing">5 stars</label>
                      </fieldset>
 
                    <div class="mb-4">
                        <label for="reviewerName" class="block text-sm font-medium text-gray-700 mb-2">Your
                            Name</label>
                        <input type="text" id="reviewerName"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="Enter your name" name="reviewerName">
                    </div>
                    <div class="mb-4">
                        <label for="reviewText" class="block text-sm font-medium text-gray-700 mb-2">Your
                            Review</label>
                        <textarea id="reviewText" rows="4"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="Write your review here..." name="review"></textarea>
                    </div>
                    <div class="flex space-x-3">
                        <button type="submit"
                            class="bg-orange-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-orange-500 transition-colors">
                            Submit Review
                        </button>
                        <button type="button" id="cancelReview"
                            class="bg-gray-300 text-gray-700 px-6 py-2 rounded-lg font-medium hover:bg-gray-400 transition-colors">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    // Toggle review form visibility
    function toggleReviewForm() {
        const form = document.getElementById('reviewForm');
        const button = document.getElementById('addReview');
        
        if (form.classList.contains('hidden')) {
            form.classList.remove('hidden');
            button.textContent = 'Hide Review Form';
        } else {
            form.classList.add('hidden');
            button.textContent = 'Write a Review';
        }
    }

    // Toggle edit form visibility for specific review
    function toggleEditForm(reviewIndex) {
        const reviewDisplay = document.getElementById(`reviewDisplay-${reviewIndex}`);
        const editForm = document.getElementById(`editForm-${reviewIndex}`);
        
        if (editForm.classList.contains('hidden')) {
            editForm.classList.remove('hidden');
            reviewDisplay.style.display = 'none';
        } else {
            editForm.classList.add('hidden');
            reviewDisplay.style.display = 'block';
        }
    }

    // Cancel review button
    document.getElementById('cancelReview').addEventListener('click', function() {
        const form = document.getElementById('reviewForm');
        const button = document.getElementById('addReview');
        
        form.classList.add('hidden');
        button.textContent = 'Write a Review';
        
        // Reset form
        document.querySelector('form[name="reviewForm"]').reset();
    });

    // Rating validation
    const reviewCountInput = document.getElementById('reviewCount');

    reviewCountInput.addEventListener('input', function () {
        const value = parseInt(this.value);
        if (value > 5) {
            this.value = 5;
            alert('Rating cannot exceed 5 stars');
        }
        if (value < 1) {
            this.value = 1;
        }
    });

    // Form submission validation
    document.querySelector('form[name="reviewForm"]').addEventListener('submit', function (e) {
        const rating = parseInt(reviewCountInput.value);
        if (rating > 5) {
            e.preventDefault();
            alert('Please enter a rating between 1 and 5');
            reviewCountInput.focus();
        }
    });
</script>
